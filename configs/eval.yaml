# Evaluation configuration for THREADS reproduction.
# This file is consumed by:
# - src/pipelines/eval_pipeline.py
# - src/eval/linear_probe.py
# - src/eval/survival_probe.py
# - src/eval/retrieval.py
# - src/eval/prompting.py
# - src/eval/metrics.py
# - src/eval/statistics.py
# - src/train/finetune_trainer.py (when eval includes finetuning)

eval:
  version: "1.0"

  stage_scope:
    mode: "evaluate"
    objective: "Reproduce THREADS downstream evaluation protocols"

  environment:
    python_version: "3.10.12"
    pytorch_version: "2.3.0"
    cuda_version: "12.3"

  benchmark:
    total_tasks: 54
    families:
      clinical_subtyping_and_grading: 8
      mutation_prediction: 21
      ihc_status_prediction: 12
      treatment_response_and_survival_prediction: 13

  shared_contract:
    embedding_dim: 1024
    tile_size: 512
    target_magnification: "20x"
    feature_key_format: "cohort/task_id/patient_id/slide_id"
    split_manifest_owner: "src/data/split_manager.py"
    split_manifest_reuse_required: true

  splits:
    k_all:
      strategy:
        - "5-fold-cross-validation"
        - "50-fold-bootstrapping"
      train_test_ratio: "80:20"
      stratification:
        label_stratified: true
        patient_stratified: true
      official_single_fold_datasets:
        - "EBRAINS"
        - "PANDA"
        - "IMP"
    few_shot:
      enabled: true
      k_values: [1, 2, 4, 8, 16, 32]
      fixed_test_set: true
      omit_infeasible_k: true

  linear_probe:
    classification:
      model: "LogisticRegression"
      implementation: "scikit-learn"
      C: 0.5
      solver: "lbfgs"
      max_iter: 10000
      class_weight: "balanced"
      hyperparameter_search: false
    survival:
      model: "CoxNet"
      implementation: "sksurv"
      max_iter: 10000
      alpha:
        overall_survival: 0.07
        progression_free_survival: 0.01
      convergence_exceptions:
        - task: "CPTAC-CCRCC overall survival"
          model: "CHIEF"
          alpha: 0.01
        - task: "BOEHMK progression-free survival"
          model: "PRISM"
          alpha: 0.02
      hyperparameter_search: false

  finetuning:
    enabled: true
    optimizer:
      name: "AdamW"
      learning_rate: 2.5e-5
      weight_decay: 0.0
      layer_wise_lr_decay: false
      gradient_accumulation: false
    training:
      epochs: 5
      batch_size: 1
      patches_per_batch: 2048
      scheduler: "1-epoch linear warmup + half-cycle cosine decay"
      early_stopping: false
      final_checkpoint: "epoch_5"
      loss_classification: "weighted cross-entropy"
    hardware:
      gpus: 1
      gpu_type: "NVIDIA 3090Ti 24GB"
      precision: "bf16"

  transferability:
    enabled: true
    train_on_all_source_samples: true
    test_on_all_external_samples: true
    bootstrap_repeats: 100

  retrieval:
    enabled: true
    distance: "L2"
    top_k: [1, 5, 10]
    metric: "mAP@k"

  prompting:
    enabled: true
    class_prompt:
      construction: "mean molecular embedding per class"
      classifier: "nearest prompt by L2"
    survival_prompt:
      low_risk: "bottom 25% uncensored survival"
      high_risk: "top 25% uncensored survival"
      risk_score: "dist_to_high - dist_to_low"

  metrics:
    binary_classification: "macro-AUC"
    multiclass_subtyping: "balanced accuracy"
    grading: "quadratic weighted Cohen's kappa"
    survival: "concordance index"

  statistics:
    per_task:
      omnibus_test: "two-way ANOVA"
      post_hoc: "two-sided Tukey HSD (multiple-comparison adjusted)"
    across_tasks:
      model: "mixed-effects model"
      random_effect: "dataset"
      fixed_effect: "model"
      pairwise: "estimated marginal means with Tukey correction"
    confidence_reporting:
      multi_fold: "mean and standard error"
      single_fold: "95% CI with non-parametric bootstrap"
      bootstrap_replicates: 100

  reporting:
    save_fold_predictions: true
    save_fold_metrics: true
    save_task_aggregates: true
    save_family_aggregates: true
    save_statistics_outputs: true

  invariants:
    - "Use identical split manifests across all methods for each task."
    - "Do not perform evaluation-time hyperparameter search."
    - "Use fixed few-shot k set: {1,2,4,8,16,32}, omitting only infeasible k."
    - "Use L2 distance for retrieval and prompting."
    - "Use configured metric-task mapping without per-model overrides."

  unresolved:
    tissue_segmentation_checkpoint: null
    proprietary_cohort_availability: null
    strategy_selection_rule_for_5fold_vs_50bootstrap: null
